[% USE Koha %]
[% USE raw %]
[% PROCESS 'i18n.inc' %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>Crontab: Configure &rsaquo; Plugins &rsaquo; Administration &rsaquo; Koha</title>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="crontab_plugin_configure" class="plugin">
    [% WRAPPER 'header.inc' %]
        [% INCLUDE 'prefs-admin-search.inc' %]
    [% END %]

    [% WRAPPER 'sub-header.inc' %]
        [% WRAPPER breadcrumbs %]
            [% WRAPPER breadcrumb_item %]
                <a href="/cgi-bin/koha/admin/admin-home.pl">Administration</a>
            [% END %]
            [% WRAPPER breadcrumb_item %]
                <a href="/cgi-bin/koha/plugins/plugins-home.pl">Plugins</a>
            [% END %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                <span>Crontab: Configure</span>
            [% END %]
        [% END #/ WRAPPER breadcrumbs %]
    [% END #/ WRAPPER sub-header.inc %]

    <div class="main container-fluid">
        <div class="row">
            <div class="col-md-10 order-md-2 order-sm-1">
                <main>
                    <h1>Crontab: Configuration</h1>
                    <!-- Notice our form here has no 'action', this is good, it means that our forms will always get passed back to 'plugins/run.pl'. You could hard code it instead if you prefer -->
                    <form method="get">
                        <!-- Always pass these two parameters so the plugin system knows what to execute! -->
                        <input type="hidden" name="class" value="[% CLASS %]"/>
                        <input type="hidden" name="method" value="[% METHOD %]"/>

                        <fieldset class="rows">
                            <legend>Global Settings</legend>

                            <ol>
                                <li>
                                    <label for="enable_logging">Enable logging: </label>
                                    <select name="enable_logging">
                                        [% IF enable_logging == 'No' %]
                                            <option value="No" selected="selected">No</option>
                                        [% ELSE %]
                                            <option value="No">No</option>
                                        [% END %]

                                        [% IF enable_logging == 'Yes' %]
                                            <option value="Yes" selected="selected">Yes</option>
                                        [% ELSE %]
                                            <option value="Yes">Yes</option>
                                        [% END %]
                                    </select>
                                </li>
                                <li>
                                    <label for="backup_retention">Crontab backup retention: </label>
                                    <input type="number" name="backup_retention" id="backup_retention"
                                           value="[% backup_retention || 10 %]" min="1" max="100" size="5" />
                                    <div class="hint">
                                        Number of crontab backup files to keep.
                                        Older backups will be automatically deleted. Default: 10
                                    </div>
                                </li>
                            </ol>
                        </fieldset>

                        <fieldset class="rows">
                            <legend>Security Settings</legend>

                            <ol>
                                <li>
                                    <label for="patron_allowlist">User allowlist: </label>
                                    <select name="patron_allowlist" id="patron_allowlist" multiple="multiple"></select>
                                    <input type="hidden" name="user_allowlist" id="user_allowlist" value="[% user_allowlist | html %]" />
                                    <div class="hint">
                                        Search and select patrons allowed to use this plugin. Leave empty to allow all staff users.
                                        <br/><strong>Note:</strong> Superlibrarians always have access regardless of this setting.
                                    </div>
                                </li>
                                <li>
                                    <label for="script_picker">Script allowlist: </label>
                                    <select name="script_picker" id="script_picker" multiple="multiple"></select>
                                    <input type="hidden" name="script_allowlist" id="script_allowlist" value="[% script_allowlist | html %]" />
                                    <div class="hint">
                                        Search and select scripts to allow users to schedule. Leave empty to allow all scripts from KOHA_CRON_PATH.
                                        <br/><strong>Note:</strong> You can also type directory prefixes (e.g., <code>batch/</code>) to allow all scripts in that directory.
                                    </div>
                                </li>
                            </ol>
                        </fieldset>

                        <fieldset class="action">
                            <input type="hidden" name="save" value="1" />
                            <input class="btn btn-primary" type="submit" value="Save" />
                            <a class="cancel" href="/cgi-bin/koha/plugins/run.pl?class=Koha%3A%3APlugin%3A%3ACom%3A%3AOpenFifth%3A%3ACrontab&method=configure">Cancel</a>
                        </fieldset>
                    </form>
                </main>
            </div> <!-- /.col-md-10.order-md-2 -->
            <div class="col-md-2 order-sm-2 order-md-1">
                <aside>
                    [% INCLUDE 'admin-menu.inc' %]
                </aside>
            </div> <!-- /.col-md-2.order-md-1 -->
        </div>
    </div>

    [% MACRO jsinclude BLOCK %]
        [% INCLUDE 'select2.inc' %]
        <script>
            $(document).ready(function() {
                $('#navmenulist a[href$="/cgi-bin/koha/plugins/plugins-home.pl"]').addClass("current");

                // Initialize patron allowlist select2
                $("#patron_allowlist").kohaSelect({
                    width: "50%",
                    multiple: true,
                    allowClear: true,
                    minimumInputLength: 3,
                    ajax: {
                        url: "/api/v1/patrons",
                        delay: 250,
                        dataType: "json",
                        headers: {
                            "x-koha-embed": "library"
                        },
                        data: function(params) {
                            let q = buildPatronSearchQuery(params.term);
                            let query = {
                                q: JSON.stringify(q),
                                _page: params.page,
                                _order_by: "+me.surname,+me.firstname"
                            };
                            return query;
                        },
                        processResults: function(data, params) {
                            let results = [];
                            data.results.forEach(function(patron) {
                                patron.id = patron.patron_id;
                                results.push(patron);
                            });
                            return {
                                results: results,
                                pagination: { more: data.pagination.more }
                            };
                        }
                    },
                    templateResult: function(patron) {
                        if (!patron.patron_id) {
                            return patron.text;
                        }

                        let $patron = $("<div></div>")
                            .append(
                                "" +
                                (patron.surname ? escape_str(patron.surname) + ", " : "") +
                                (patron.firstname ? escape_str(patron.firstname) + " " : "") +
                                (patron.cardnumber ? " (" + escape_str(patron.cardnumber) + ")" : "") +
                                "<small>" +
                                (patron.library ? ' <span class="ac-library">' + escape_str(patron.library.name) + "</span>" : "") +
                                "</small>"
                            );
                        return $patron;
                    },
                    templateSelection: function(patron) {
                        if (!patron.surname) {
                            return patron.text;
                        }
                        return escape_str(patron.surname) + ", " + escape_str(patron.firstname);
                    },
                    placeholder: __("Search for patrons to allow access")
                });

                // Load existing patrons if any
                let existingIds = $("#user_allowlist").val();
                if (existingIds) {
                    let patronIds = existingIds.split(/\s*,\s*/);
                    patronIds.forEach(function(patronId) {
                        if (patronId) {
                            $.ajax({
                                url: "/api/v1/patrons/" + patronId,
                                dataType: "json"
                            }).done(function(patron) {
                                let option = new Option(
                                    patron.surname + ", " + patron.firstname,
                                    patron.patron_id,
                                    true,
                                    true
                                );
                                $("#patron_allowlist").append(option).trigger('change');
                            });
                        }
                    });
                }

                // Initialize script allowlist select2
                let allScripts = [];

                // Load all available scripts (with bypass_filter=1 to see all scripts for configuration)
                $.ajax({
                    url: '/api/v1/contrib/crontab/scripts?bypass_filter=1',
                    method: 'GET',
                    success: function(data) {
                        if (data.scripts) {
                            allScripts = data.scripts;
                            initializeScriptPicker();
                        }
                    },
                    error: function() {
                        console.error('Failed to load scripts');
                    }
                });

                function initializeScriptPicker() {
                    $("#script_picker").select2({
                        width: "75%",
                        multiple: true,
                        allowClear: true,
                        tags: true, // Allow custom entries like "batch/" for directory prefixes
                        data: allScripts.map(function(script) {
                            return {
                                id: script.relative_path.replace(/^\$KOHA_CRON_PATH\/?/, ''),
                                text: script.name,
                                description: script.description,
                                path: script.relative_path.replace(/^\$KOHA_CRON_PATH\/?/, ''),
                                type: script.type
                            };
                        }),
                        templateResult: function(script) {
                            if (!script.id) {
                                return script.text;
                            }

                            let $script = $("<div></div>");
                            let html = '<strong>' + escape_str(script.text) + '</strong>';

                            if (script.type) {
                                html += ' <span class="badge badge-secondary">' + script.type + '</span>';
                            }

                            if (script.description) {
                                html += '<br><small class="text-muted">' + escape_str(script.description) + '</small>';
                            }

                            if (script.path) {
                                html += '<br><small><code>' + escape_str(script.path) + '</code></small>';
                            }

                            $script.html(html);
                            return $script;
                        },
                        templateSelection: function(script) {
                            if (script.text) {
                                return escape_str(script.text);
                            }
                            return escape_str(script.id);
                        },
                        placeholder: "Select scripts or type directory prefixes (e.g., batch/)"
                    });

                    // Load existing scripts if any
                    let existingScripts = $("#script_allowlist").val();
                    if (existingScripts) {
                        let scripts = existingScripts.split(/\r?\n/).filter(s => s.trim());
                        scripts.forEach(function(scriptPath) {
                            scriptPath = scriptPath.trim();
                            if (scriptPath) {
                                // Check if it already exists in our data
                                let existingOption = allScripts.find(s =>
                                    s.relative_path.replace(/^\$KOHA_CRON_PATH\/?/, '') === scriptPath ||
                                    s.name === scriptPath
                                );

                                let displayText = existingOption ? existingOption.name : scriptPath;
                                let option = new Option(displayText, scriptPath, true, true);
                                $("#script_picker").append(option);
                            }
                        });
                        $("#script_picker").trigger('change');
                    }
                }

                // Update hidden fields on form submit
                $("form").on("submit", function() {
                    // Handle patron allowlist
                    let selectedIds = $("#patron_allowlist").val();
                    if (selectedIds && selectedIds.length > 0) {
                        $("#user_allowlist").val(selectedIds.join(","));
                    } else {
                        $("#user_allowlist").val("");
                    }

                    // Handle script allowlist
                    let selectedScripts = $("#script_picker").val();
                    if (selectedScripts && selectedScripts.length > 0) {
                        $("#script_allowlist").val(selectedScripts.join("\n"));
                    } else {
                        $("#script_allowlist").val("");
                    }
                });
            });
        </script>
    [% END %]

[% INCLUDE 'intranet-bottom.inc' %]
